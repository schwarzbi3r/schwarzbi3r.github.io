<!doctype html><html><head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge"><title>Playing with Solana Serialization - SchwarzBier</title><meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="While exploring Solana, I wanted to get a better handle on how Solana serializes its own data. In order to do this I built a tool to quickly look at data on an account. Normally, consumers would have the RPC server parse the account data into its relevant fields. In my case, I&rsquo;m looking at the raw data and ignoring any parsing in order to better understand the serialization handling.">
<meta property="og:image" content>
<meta property="og:title" content="Playing with Solana Serialization">
<meta property="og:description" content="While exploring Solana, I wanted to get a better handle on how Solana serializes its own data. In order to do this I built a tool to quickly look at data on an account. Normally, consumers would have the RPC server parse the account data into its relevant fields. In my case, I&rsquo;m looking at the raw data and ignoring any parsing in order to better understand the serialization handling.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://SchwarzBi3r.github.io/posts/2022-01-26-solana-serialization/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2022-01-26T12:03:43-05:00">
<meta property="article:modified_time" content="2022-01-26T12:03:43-05:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Playing with Solana Serialization">
<meta name=twitter:description content="While exploring Solana, I wanted to get a better handle on how Solana serializes its own data. In order to do this I built a tool to quickly look at data on an account. Normally, consumers would have the RPC server parse the account data into its relevant fields. In my case, I&rsquo;m looking at the raw data and ignoring any parsing in order to better understand the serialization handling.">
<link href=https://SchwarzBi3r.github.io/css/fonts.b685ac6f654695232de7b82a9143a46f9e049c8e3af3a21d9737b01f4be211d1.css rel=stylesheet>
<link rel=stylesheet type=text/css media=screen href=https://SchwarzBi3r.github.io/css/main.2f9b5946627215dc1ae7fa5f82bfc9cfcab000329136befeea5733f21e77d68f.css>
</head>
<body>
<div class=content><header>
<div class=main>
<a href=https://SchwarzBi3r.github.io>SchwarzBier</a>
</div>
<nav>
</nav>
</header>
<main>
<article>
<div class=title>
<h1 class=title>Playing with Solana Serialization</h1>
<div class=meta>Posted on Jan 26, 2022</div>
</div>
<section class=body>
<p>While exploring Solana, I wanted to get a better handle on how Solana serializes its own data. In order to do this <a href=https://schwarzbi3r.github.io/solana-hack-n-hex>I built a tool</a> to quickly look at data on an account. Normally, consumers would have the RPC server parse the account data into its relevant fields. In my case, I&rsquo;m looking at the raw data and ignoring any parsing in order to better understand the serialization handling.</p>
<h2 id=lets-get-started-with-the-hex-viewer>Let&rsquo;s get started with the hex viewer</h2>
<p>To start, let&rsquo;s look at a program account. These break down into a &lsquo;program account&rsquo; and a &lsquo;program data account&rsquo; which actually holds the program&rsquo;s executable data.</p>
<p>In this case let&rsquo;s use Metaplex&rsquo;s token program<a href=https://schwarzbi3r.github.io/solana-hack-n-hex/#/mainnet-beta/account/metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s><code>metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s</code></a></p>
<p>If we look at the raw data we can see it&rsquo;s</p>
<p><code>02 00 00 00 05 E0 15 6C A7 D5 D4 E9 C8 42 21 BF 8A 4B D5 B6 BF 5E 54 4A 33 CD 53 CB 20 0B 23 49 3C B4 68 10</code></p>
<p>This actually contains a serialized rust enum that looks like:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>enum</span> <span style=color:#a6e22e>UpgradeableLoaderState</span> {
    <span style=color:#e6db74>/// Account is not initialized.
</span><span style=color:#e6db74></span>    Uninitialized,
    <span style=color:#e6db74>/// A Buffer account.
</span><span style=color:#e6db74></span>    Buffer {
        <span style=color:#e6db74>/// Authority address
</span><span style=color:#e6db74></span>        authority_address: Option<span style=color:#f92672>&lt;</span>Pubkey<span style=color:#f92672>&gt;</span>,
        <span style=color:#75715e>// The raw program data follows this serialized structure in the
</span><span style=color:#75715e></span>        <span style=color:#75715e>// account&#39;s data.
</span><span style=color:#75715e></span>    },
    <span style=color:#e6db74>/// An Program account.
</span><span style=color:#e6db74></span>    Program {
        <span style=color:#e6db74>/// Address of the ProgramData account.
</span><span style=color:#e6db74></span>        programdata_address: <span style=color:#a6e22e>Pubkey</span>,
    },
    <span style=color:#75715e>// A ProgramData account.
</span><span style=color:#75715e></span>    ProgramData {
        <span style=color:#e6db74>/// Slot that the program was last modified.
</span><span style=color:#e6db74></span>        slot: <span style=color:#66d9ef>u64</span>,
        <span style=color:#e6db74>/// Address of the Program&#39;s upgrade authority.
</span><span style=color:#e6db74></span>        upgrade_authority_address: Option<span style=color:#f92672>&lt;</span>Pubkey<span style=color:#f92672>&gt;</span>,
        <span style=color:#75715e>// The raw program data follows this serialized structure in the
</span><span style=color:#75715e></span>        <span style=color:#75715e>// account&#39;s data.
</span><span style=color:#75715e></span>    },
}
</code></pre></div><p>Now it should become more clear how this got serialized. <code>02 00 00 00</code> is a <code>u32</code> denoting the 3rd (starting from 0x00) type in the enum, <code>Program</code>, which contains a Public key, which is <code>[u8; 32]</code> and starts from the 0x05.</p>
<p>Clicking the byte <code>0x05</code> at offset 0x04, we can see it gives us the key <a href=https://schwarzbi3r.github.io/solana-hack-n-hex/#/mainnet-beta/account/PwDiXFxQsGra4sFFTT8r1QWRMd4vfumiWC1jfWNfdYT><code>PwDiXFxQsGra4sFFTT8r1QWRMd4vfumiWC1jfWNfdYT</code></a>.</p>
<p><img src=/2022-01-26-solana-serialization/bpf-loader-program-hex.png alt=bpf-loader-program></p>
<p>Then we pull up the program data at <a href=https://schwarzbi3r.github.io/solana-hack-n-hex/#/mainnet-beta/account/PwDiXFxQsGra4sFFTT8r1QWRMd4vfumiWC1jfWNfdYT><code>PwDiXFxQsGra4sFFTT8r1QWRMd4vfumiWC1jfWNfdYT</code></a>:</p>
<p><img src=/2022-01-26-solana-serialization/bpf-loader-program-data-hex.png alt=bpf-loader-program-data></p>
<p>And while it&rsquo;s a whopping 694k of program data, we just want to pay attention to the header, which is defined in the enum as:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust>    <span style=color:#75715e>// A ProgramData account.
</span><span style=color:#75715e></span>    ProgramData {
        <span style=color:#e6db74>/// Slot that the program was last modified.
</span><span style=color:#e6db74></span>        slot: <span style=color:#66d9ef>u64</span>,
        <span style=color:#e6db74>/// Address of the Program&#39;s upgrade authority.
</span><span style=color:#e6db74></span>        upgrade_authority_address: Option<span style=color:#f92672>&lt;</span>Pubkey<span style=color:#f92672>&gt;</span>,
        <span style=color:#75715e>// The raw program data follows this serialized structure in the
</span><span style=color:#75715e></span>        <span style=color:#75715e>// account&#39;s data.
</span><span style=color:#75715e></span>    },
</code></pre></div><p>So as expected, we have <code>03 00 00 00</code> denoting the 4th enum (ProgramData), followed by a <code>u64</code> slot of <code>D1 12 F7 06 00 00 00 00</code> or 116855505 in base 10. Then we have a value of &lsquo;01&rsquo; which implies the 2nd enum in Option (Some), and we can verify that from the std::option code in rust, which is:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>enum</span> Option<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> {
    None,
    Some(T),
}
</code></pre></div><p>And finally, we have our &lsquo;upgrade_authority_address&rsquo; which is a <code>[u8; 32]</code> of <a href=https://schwarzbi3r.github.io/solana-hack-n-hex/#/mainnet-beta/account/AqH29mZfQFgRpfwaPoTMWSKJ5kqauoc1FwVBRksZyQrt><code>AqH29mZfQFgRpfwaPoTMWSKJ5kqauoc1FwVBRksZyQrt</code></a></p>
<p>This all sounds reasonable, but can we replicate this serialization in Rust? It&rsquo;s actually pretty easy. It uses the libraries &lsquo;serde&rsquo; and &lsquo;bincode&rsquo; to do the actual serialization and deserialization, so with just a quick implementation of the enum along with a small test, we can reproduce the same data that we see showing up in Solana.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#66d9ef>use</span> serde::{Serialize, Deserialize};

<span style=color:#75715e>#[derive(Debug, Serialize, Deserialize, PartialEq, Clone, Copy)]</span>
<span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>Pubkey</span>([<span style=color:#66d9ef>u8</span>; <span style=color:#ae81ff>32</span>]);

<span style=color:#75715e>#[derive(Debug, Serialize, Deserialize, PartialEq, Clone, Copy)]</span>
<span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>enum</span> <span style=color:#a6e22e>UpgradeableLoaderState</span> {
    <span style=color:#e6db74>/// Account is not initialized.
</span><span style=color:#e6db74></span>    Uninitialized,
    <span style=color:#e6db74>/// A Buffer account.
</span><span style=color:#e6db74></span>    Buffer {
        <span style=color:#e6db74>/// Authority address
</span><span style=color:#e6db74></span>        authority_address: Option<span style=color:#f92672>&lt;</span>Pubkey<span style=color:#f92672>&gt;</span>,
        <span style=color:#75715e>// The raw program data follows this serialized structure in the
</span><span style=color:#75715e></span>        <span style=color:#75715e>// account&#39;s data.
</span><span style=color:#75715e></span>    },
    <span style=color:#e6db74>/// An Program account.
</span><span style=color:#e6db74></span>    Program {
        <span style=color:#e6db74>/// Address of the ProgramData account.
</span><span style=color:#e6db74></span>        programdata_address: <span style=color:#a6e22e>Pubkey</span>,
    },
    <span style=color:#75715e>// A ProgramData account.
</span><span style=color:#75715e></span>    ProgramData {
        <span style=color:#e6db74>/// Slot that the program was last modified.
</span><span style=color:#e6db74></span>        slot: <span style=color:#66d9ef>u64</span>,
        <span style=color:#e6db74>/// Address of the Program&#39;s upgrade authority.
</span><span style=color:#e6db74></span>        upgrade_authority_address: Option<span style=color:#f92672>&lt;</span>Pubkey<span style=color:#f92672>&gt;</span>,
        <span style=color:#75715e>// The raw program data follows this serialized structure in the
</span><span style=color:#75715e></span>        <span style=color:#75715e>// account&#39;s data.
</span><span style=color:#75715e></span>    },
}

<span style=color:#75715e>#[test]</span>
<span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>test_serialization</span>() {
    <span style=color:#66d9ef>use</span> bincode;
    <span style=color:#66d9ef>use</span> pretty_hex::<span style=color:#f92672>*</span>;

    <span style=color:#75715e>// pubkey: &#39;AqH29mZfQFgRpfwaPoTMWSKJ5kqauoc1FwVBRksZyQrt&#39;
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>let</span> pubkey: [<span style=color:#66d9ef>u8</span>; <span style=color:#ae81ff>32</span>] <span style=color:#f92672>=</span> [
        <span style=color:#ae81ff>0x92</span>, <span style=color:#ae81ff>0x17</span>, <span style=color:#ae81ff>0x02</span>, <span style=color:#ae81ff>0xC4</span>, <span style=color:#ae81ff>0x72</span>, <span style=color:#ae81ff>0x5D</span>, <span style=color:#ae81ff>0xC0</span>, <span style=color:#ae81ff>0x41</span>,
        <span style=color:#ae81ff>0xF9</span>, <span style=color:#ae81ff>0xDD</span>, <span style=color:#ae81ff>0x8C</span>, <span style=color:#ae81ff>0x51</span>, <span style=color:#ae81ff>0x52</span>, <span style=color:#ae81ff>0x60</span>, <span style=color:#ae81ff>0x04</span>, <span style=color:#ae81ff>0x26</span>,
        <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x93</span>, <span style=color:#ae81ff>0x0A</span>, <span style=color:#ae81ff>0x0B</span>, <span style=color:#ae81ff>0x02</span>, <span style=color:#ae81ff>0x73</span>, <span style=color:#ae81ff>0xDC</span>, <span style=color:#ae81ff>0xFA</span>,
        <span style=color:#ae81ff>0x74</span>, <span style=color:#ae81ff>0x92</span>, <span style=color:#ae81ff>0x17</span>, <span style=color:#ae81ff>0xFC</span>, <span style=color:#ae81ff>0x94</span>, <span style=color:#ae81ff>0xA2</span>, <span style=color:#ae81ff>0x40</span>, <span style=color:#ae81ff>0x49</span>
        ];
    <span style=color:#75715e>// The object that we will serialize.
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>let</span> target <span style=color:#f92672>=</span> UpgradeableLoaderState::ProgramData {
        slot: <span style=color:#ae81ff>116855505</span>,
        upgrade_authority_address: Some(Pubkey(pubkey)),
    };

    <span style=color:#66d9ef>let</span> encoded: Vec<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>u8</span><span style=color:#f92672>&gt;</span> <span style=color:#f92672>=</span> bincode::serialize(<span style=color:#f92672>&amp;</span>target).unwrap();
    println!(<span style=color:#e6db74>&#34;{}&#34;</span>, encoded.hex_dump());

    <span style=color:#75715e>// The raw account data from AqH29mZfQFgRpfwaPoTMWSKJ5kqauoc1FwVBRksZyQrt
</span><span style=color:#75715e></span>    <span style=color:#75715e>// https://schwarzbi3r.github.io/solana-hack-n-hex/#/mainnet-beta/account/PwDiXFxQsGra4sFFTT8r1QWRMd4vfumiWC1jfWNfdYT
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>let</span> expected: [<span style=color:#66d9ef>u8</span>; <span style=color:#ae81ff>45</span>] <span style=color:#f92672>=</span> [
        <span style=color:#ae81ff>0x03</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x00</span>,
        <span style=color:#ae81ff>0xD1</span>, <span style=color:#ae81ff>0x12</span>, <span style=color:#ae81ff>0xF7</span>, <span style=color:#ae81ff>0x06</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x00</span>,
        <span style=color:#ae81ff>0x01</span>,
        <span style=color:#ae81ff>0x92</span>, <span style=color:#ae81ff>0x17</span>, <span style=color:#ae81ff>0x02</span>, <span style=color:#ae81ff>0xC4</span>, <span style=color:#ae81ff>0x72</span>, <span style=color:#ae81ff>0x5D</span>, <span style=color:#ae81ff>0xC0</span>, <span style=color:#ae81ff>0x41</span>,
        <span style=color:#ae81ff>0xF9</span>, <span style=color:#ae81ff>0xDD</span>, <span style=color:#ae81ff>0x8C</span>, <span style=color:#ae81ff>0x51</span>, <span style=color:#ae81ff>0x52</span>, <span style=color:#ae81ff>0x60</span>, <span style=color:#ae81ff>0x04</span>, <span style=color:#ae81ff>0x26</span>,
        <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x93</span>, <span style=color:#ae81ff>0x0A</span>, <span style=color:#ae81ff>0x0B</span>, <span style=color:#ae81ff>0x02</span>, <span style=color:#ae81ff>0x73</span>, <span style=color:#ae81ff>0xDC</span>, <span style=color:#ae81ff>0xFA</span>,
        <span style=color:#ae81ff>0x74</span>, <span style=color:#ae81ff>0x92</span>, <span style=color:#ae81ff>0x17</span>, <span style=color:#ae81ff>0xFC</span>, <span style=color:#ae81ff>0x94</span>, <span style=color:#ae81ff>0xA2</span>, <span style=color:#ae81ff>0x40</span>, <span style=color:#ae81ff>0x49</span>
        ];
    assert_eq!(expected.to_vec(), encoded)
}
</code></pre></div><p>You can find the above code at <a href=https://github.com/schwarzbi3r/schwarzbi3r.github.io/tree/main/code_examples/solana_serialization>https://github.com/schwarzbi3r/schwarzbi3r.github.io/tree/main/code_examples/solana_serialization</a></p>
</section>
<div class=post-tags>
</div>
</article>
</main>
<footer>
<hr>⚡️
2022 Schwarzbier | Built with <a href=https://gohugo.io>Hugo</a>
</footer>
</div>
</body>
</html>